<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Ready Net For ISPs</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link href="css/map.css" rel="stylesheet" />

    <style>

    </style>

  </head>

  <body>

    <div id='map'></div>
    <div class='map-overlay'>
      <div class='countycontainer'>
        <h2>RDOF @ Counties</h2>
          <div id='pd'><h3>Hover over a county!</h3>
            <h5><p>Eligible Locations: </p>0<br>
            <p>Reserved Price: </p>0<br></h5>
            
          </div>
          <h2>Census Block Groups</h2>
      </div>
      
      <div class="cbgcontainer">
      
      <h3><strong>Socioeconomic Factors</strong></h3>
      <h5 id='hacs'>
        <p>Population: </p> 0<br>
        <!-- <p>Area: </p> 0<br> -->
        <p>Median Household Income: </p> 0<br>
        <p>% Owner Occupied Housing Units: </p> 0<br>
        <p>% With Bachelor Degree: </p> 0<br>
        <p>% Senior (65+): </p>0<br>
        <!-- <p>% Senior: </p>0<br> -->
      </h5>

      <!-- <h3><strong>RDOF Details</strong></h3>
      <h5 id='hrdof'>
        <p>Eligible Locations: </p>0<br>
        <p>Reserved Price: </p>0<br>
      </h5> -->

      <h3><strong>Competitors</strong> </h3>
      <h5 id = 'isp'>
        <p>Number of Known ISPs: </p>0<br>
        <!-- <p>Number of Fiber Providers: </p>0<br> -->
        <!-- <p>Largest Provider @ Current CBG: </p>0<br>
        <p>Holding Company Name: </p>0<br> -->
      </h5>

      <h3><strong>ISP Listing</strong> </h3>
      <div id = 'listings' class='listings'>
      </div>
      </div>
    </div>

    <!-- <div class='legend' id='legend'>

      <h3>Number of Eligible Locations</h3>
      <div class="location-legend" id="location-id"></div>
      <div class="labels-legend">
        <span class="as-caption" >0 </span>
        <span class="as-caption" >36,000+ </span>

      </div> -->

      <!-- <div class='sidebar'>
        <div class='heading' id='heading'>
          <h1>ISPs in the CBG</h1>
        </div>
        <div id='listings' class='listings'></div>
      </div> -->

<!-- add search bars -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>
    <link
    rel="stylesheet"
    href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css"
    type="text/css"
    />
  <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>


  <script>
    var hoveredcbgId = null;
    ////////////////////////////////////////////////////////////////////////
/////////////////////// ISP data here////////////////////////////////////
// this is a sample data that each cbg only have two ISPs, you could use your database solution to replace this////
    var dataurl = 'https://raw.githubusercontent.com/brookefzy/readynet/master/data/03_isp_sample.csv'
    // this is a sample data that each cbg only have two ISPs, you could use your database solution to replace this////

    mapboxgl.accessToken = 'pk.eyJ1IjoieXVhbnpmIiwiYSI6ImNrOXc4a3VwbzA2eGkzZHJ6bzg4anNpaHMifQ.xSyKndi9kO3wlTEnVnrDzA';

    var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/yuanzf/ck9wzv7l10o4k1imog78f29ft' // replace this with your style URL
    });

////////////////////////////////////////////////////////////////////////
/////////////////////// helperfunctions////////////////////////////////////
////////////////////////////////////////////////////////////////////////
function formatNumber(num) {
  return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
}
function formatNumber2(num) {
  return num.toFixed(2).toString()
}

function currencyFormat(num) {
  return '$' + num.toFixed(2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
}
////////////////////////////////////////////////////////////////////////
////////////////////////////////////// helperfunctions//////////////////
////////////////////////////////////////////////////////////////////////
      map.on('mousemove', function(e) {
        var counties = map.queryRenderedFeatures(e.point, {
          layers: ['rdofcounty']
          
        });
        
        
        if (counties.length > 0) {
          // console.log(counties)
          document.getElementById('pd').innerHTML = '<h3><strong>' + counties[0].properties.county_nam + ' County</h3></strong>'+
            '<h5><p>Eligible Locations: <strong></p>' + formatNumber(counties[0].properties.location) + '</strong><p> Total Reserved Price: <strong></p>' + currencyFormat(counties[0].properties.price) + '</strong></h5>';
        } else {
          document.getElementById('pd').innerHTML = '<h3>Hover over a county!</h3><h5><p>Eligible Locations: </p>0<br><p>Reserved Price: </p>0<br></h5>';
        }
      });

      map.on('mousemove', function(e) {
        var cbgs = map.queryRenderedFeatures(e.point, {
          layers: ['rdof-group']
          
        });
        
      });

      ////////////////////////////////////////////////////////////////////////
      ///////////////////////create popup////////////////////////////////////
      ////////////////////////////////////////////////////////////////////////
      map.on('click','rdof-group', function(e) {

        var cbgfips=e.features[0].properties.FIPS_cbg


        console.log(e.features[0].properties)
        document.getElementById('hacs').innerHTML = '<p>Population: </p>' +formatNumber(e.features[0].properties.pop)+'<br>'
                                              
                                                        + '<p>Median Household Income: </p>'+ currencyFormat(e.features[0].properties.income_m_h)+'<br>'
                                                        + '<p>% Owner Occupied Housing Units: </p>'+ e.features[0].properties.housingowner_perc+'% <br>'
  
                                                        +'<p>% With Bachelor Degree: </p>'+ formatNumber2(e.features[0].properties.edu_bachelor_above)+'% <br>'
                                                        +'<p>% Senior (65+): </p>'+ formatNumber2(e.features[0].properties.senior_perc) +'% <br>';
                                                        // +'<p>% Senior:</p>'+ e.features[0].properties.seniorPerc + '% ';
        // document.getElementById('hrdof').innerHTML = '<p>Eligible Locations: </p>' + formatNumber(e.features[0].properties.locations)+ '<br>'
        //                                                 + '<p>Reserved Price: </p>'+ currencyFormat(e.features[0].properties.reserve)

       document.getElementById('isp').innerHTML = '<p>Number of Known ISPs: </p>'+formatNumber(e.features[0].properties.num_isp)+'<br>';
                                                  // '<br><p>Number of Fiber Providers: </p>'+e.features[0].properties.is_fiber +'<br>';
                                                  // '<br><p>Largest Provider @ Current CBG: </p>'+e.features[0].properties.ProviderName_01 +
                                                  // '<br><p>Holding Company Name: </p>'+e.features[0].properties.HoldingCompanyName_01+'<br>';

          new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML('<p>Census Block Group ID: '+ e.features[0].properties.FIPS_cbg+'</p>'+
          '</h2><p>Local Population: '+ formatNumber(e.features[0].properties.pop)+'</p><br>'
            +'<h3><strong>Eligible Locations: </strong></h3><h2>'+ formatNumber(e.features[0].properties.locations)+
            '<br></h2><h3><strong>Reserved Price: </strong></h3><h2>'+ currencyFormat(e.features[0].properties.reserve)
            )
          .addTo(map);

///////////////////////////////////////////////////////////////////////  
///////////////////////Load ISP Data////////////////////////////////////
/////////////////////////////////////////////////////////////////////// 
////This is a sample file, only list two ISPs per cbg//////////////////

          d3.csv(dataurl).then(function(isps){

            console.log(isps)
            var query = {'FIPS_cbg': cbgfips}
            var selisps = isps.filter(search, query);
            function search(user){
              return Object.keys(this).every((key) => user[key] === this[key]);
            }
            buildISPList(selisps)

            });
          });
          
          // Change the cursor to a pointer when the mouse is over the states layer.
          map.on('mouseenter', 'rdof-group', function() {
          map.getCanvas().style.cursor = 'pointer';
          });
          
          // Change it back to a pointer when it leaves.
          map.on('mouseleave', 'rdof-group', function() {
          map.getCanvas().style.cursor = '';
          });






///////////////////////////////////////////////////////////////////////  
////////////////////////geocoding control//////////////////////////////
///////////////////////////////////////////////////////////////////////      

      map.addControl(
      new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl
      })
      );

///////////////////////////////////////////////////////////////////////  
///////////////////////ISP Listings////////////////////////////////////
/////////////////////////////////////////////////////////////////////// 
function buildISPList(data) {
  document.getElementById('listings').innerHTML=""
  data.forEach(function(isp, i){
    /**
     * Create a shortcut for `store.properties`,
     * which will be used several times below.
    **/
    // var prop = isp.properties;

    /* Add a new listing section to the sidebar. */
    
    var listings = document.getElementById('listings');
    var listing = listings.appendChild(document.createElement('div'));
    /* Assign a unique `id` to the listing. */
    listing.id = "listing-" + isp.id;
    /* Assign the `item` class to each listing for styling. */
    listing.className = 'item';

    /* Add the link to the individual listing created above. */
    var link = listing.appendChild(document.createElement('a'));
    link.href = '#';
    link.className = 'title';
    link.id = "link-" + isp.id;
    link.innerHTML = isp.DBAName;

    /* Add details to the individual listing. */
    var details = listing.appendChild(document.createElement('h5'));
    details.innerHTML = "<p>Holding Company Name: </p>"+ isp.HoldingCompanyName + "<br>"+
                    "<p>Maximum Download Speed: </p>"+ isp.MaxAdDown +"<br>"+
                        "<p>Maximum Upload Speed: </p>"+ isp.MaxAdUp;

  });
}







  </script>



  </body>

</html>
